<!DOCTYPE html><html lang="en-US"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>How to Build a Credit Risk Model</title><meta name="description" content="A Data Scientists Guide to Building a Basic Credit Risk Model"/><meta property="og:type" content="website"/><meta name="og:title" property="og:title" content="How to Build a Credit Risk Model"/><meta name="og:description" property="og:description" content="A Data Scientists Guide to Building a Basic Credit Risk Model"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="How to Build a Credit Risk Model"/><meta name="twitter:description" content="A Data Scientists Guide to Building a Basic Credit Risk Model"/><meta name="twitter:creator" content="franciscojarceo"/><link rel="icon" type="image/png" href="/favicon.ico"/><link rel="apple-touch-icon" href="/favicon.ico"/><link rel="preload" href="/assets/liftchart.png" as="image" fetchPriority="high"/><link rel="preload" href="/assets/liftchart_optimal.png" as="image" fetchPriority="high"/><meta name="next-head-count" content="15"/><link rel="preload" href="/_next/static/css/2ddc893e6f67eaa4.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/2ddc893e6f67eaa4.css" crossorigin="" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" crossorigin="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-2555a4296ab7a1b2.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/framework-fae63b21a27d6472.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/main-de2c74f8722a8d2e.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/_app-0eb7e304a6637746.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/401-6e60ee3ab13a84ce.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/165-4ec2600001888911.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/post/%5Bslug%5D-14754cb6b0504a35.js" defer="" crossorigin=""></script><script src="/_next/static/kJxfpRQQyGIN4m6m9HTPj/_buildManifest.js" defer="" crossorigin=""></script><script src="/_next/static/kJxfpRQQyGIN4m6m9HTPj/_ssgManifest.js" defer="" crossorigin=""></script></head><body><div id="__next"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><div class="w-full min-h-screen dark:bg-dark-bg dark:text-white"><div class="max-w-screen-md px-4 py-12 mx-auto antialiased font-body"><header class="flex items-center justify-between  mb-2"><meta name="description" content="My chaotic thoughts on computers, statistics, finance, and data"/><meta name="keywords" content="francisco javier arceo, data science, finance, fintech, engineering, django, python"/><meta property="og:type" content="website"/><meta property="og:title" content="Francisco&#x27;s Random Thoughts"/><meta property="og:locale" content="en_US"/><meta property="og:description" content="My chaotic thoughts on computers, statistics, finance, and data"/><meta property="og:image" content="https://og-image.now.sh/Francisco&#x27;s%20Random%20Thoughts.png?theme=light&amp;md=0&amp;fontSize=75px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><meta name="twitter:description" content="My chaotic thoughts on computers, statistics, finance, and data"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="franciscojarceo"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-71125809-1/"></script><script src="/ga.js"></script><div class="max-w-md"><a class="text-2xl font-black text-black no-underline font-display dark:text-white" href="/">Francisco Javier Arceo</a></div><script type="application/ld+json">{"@context":"https://schema.org","@type":"Person","name":"Francisco Javier Arceo","alternateName":"Francisco&apos;s Random Thoughts","alumniOf":{"@type":"CollegeOrUniversity","name":["Columbia University in the City of New York","Clemson University","Illinois State University"]},"knowsAbout":["Django","Data Science","Statistics","Machine Learning","Economics","Econometrics","Computer Science","Natural Language Processing"]}</script></header><main style="padding-bottom:10px"><article><header class="mb-8"><h1 class="mb-2 text-6xl font-black leading-none font-display">How to Build a Credit Risk Model</h1><p class="text-sm">January 31, 2021</p></header><div class="mb-4 prose lg:prose-lg dark:prose-dark"><p><em>TL;DR: A Data Science Tutorial on building a Credit Risk model.</em></p>
<p>I previously <a href="/post/data-science-and-fintech">wrote</a> about some of the work data scientists do in the fintech space, which briefly discussed <a href="https://en.wikipedia.org/wiki/Credit_risk">credit risk models</a> but I wanted to write a more technical review and talk about what I think are the most important points.</p>
<p>I spent most of my career at banks as a data scientist and built credit risk, fraud, and marketing models in the consumer and commercial space in the US, Australia, and South Africa. I learned a lot from those experiences, so I thought I&#x27;d share a simple example of how one of the core pieces of algorithmic/quantitative underwriting is done.</p>
<p>In this post, I&#x27;ll try to answer the following questions:</p>
<ul>
<li>What is a credit risk model?</li>
<li>What data does a credit risk model use?</li>
<li>How do you estimate a credit risk model?</li>
<li>How do you know if your model is performing well?</li>
<li>What are some common mistakes to avoid?</li>
<li>What are useful facts to know about credit risk models?</li>
</ul>
<p>It&#x27;s worth caveating up front that this is a very narrow take focused only on the analytical aspect of the work and there is an extraordinary amount of legal, compliance, and business work that I am intentionally omitting.</p>
<p>With that said, let&#x27;s dive right in.</p>
<h2>What is a Credit Risk Model?</h2>
<p>In the consumer/retail space, a credit risk model tries to predict the probability that a consumer won&#x27;t repay money that they&#x27;ve borrowed.
A simple example of this is an <a href="https://www.investopedia.com/terms/u/unsecuredloan.asp">unsecured personal loan</a>.</p>
<p>Let&#x27;s suppose you submitted an application to borrow $5,000 from a lender. That lender would want to know the likelihood of <a href="https://www.investopedia.com/terms/d/default2.asp">default</a> before deciding on (1) whether to give you the loan and (2) the price they want to charge you for borrowing the money. So that probability is probably quite important...but how do they come up with it?</p>
<h2>What Data does a Credit Risk Model Use?</h2>
<p>Lenders typically use data from the major <a href="https://www.investopedia.com/personal-finance/top-three-credit-bureaus/">Credit Bureaus</a> that is <a href="https://www.ftc.gov/enforcement/statutes/fair-credit-reporting-act">FCRA</a> compliant, which basically means that the legal and reputational risk of using this data is very low.</p>
<p>Typically, you&#x27;d purchase a dataset from one of the bureaus (or use data inside one of their analytical sandboxes) and clean the dataset into something that looks like the following:</p>
<!-- -->&lt;table&gt;
  &lt;tr&gt;
    &lt;th&gt;Default&lt;/th&gt;
    &lt;th&gt;Inquiries in Last 6 Months&lt;/th&gt;
    &lt;th&gt;Credit Utilization&lt;/th&gt;
    &lt;th&gt;Average Age of Credit&lt;/th&gt;
    &lt;th&gt;...&lt;/th&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;Yes&lt;/td&gt;
    &lt;td&gt;2&lt;/td&gt;
    &lt;td&gt;0.8&lt;/td&gt;
    &lt;td&gt;12&lt;/td&gt;
    &lt;td&gt;...&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;No&lt;/td&gt;
    &lt;td&gt;8&lt;/td&gt;
    &lt;td&gt;0.0&lt;/td&gt;
    &lt;td&gt;2&lt;/td&gt;
    &lt;td&gt;...&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;...&lt;/td&gt;
    &lt;td&gt;...&lt;/td&gt;
    &lt;td&gt;...&lt;/td&gt;
    &lt;td&gt;...&lt;/td&gt;
    &lt;td&gt;...&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;<!-- -->
<p>And so on.</p>
<p>In summary, it&#x27;s just a bunch of data about your borrowing history.
It&#x27;s a little recursive/cyclical because in order to grow your credit you need to have credit but let&#x27;s ignore that detail.</p>
<p>One of the most important steps in the model development process is <em>precisely</em> defining <strong>default</strong> because this will eventually reflect the performance of your portfolio defining it thoughtfully, accurately, and confidently is extremely consequential.</p>
<p>So how do you define it?</p>
<p>Time.</p>
<p>If you&#x27;re planning to launch a term loan, you usually set boundaries on the duration of the loan. For revolving lines of credit (like a credit card), you simply apply a reasonable boundary on time that makes good business sense.</p>
<p>Let&#x27;s say you want to launch a 12 month loan to an underserved market, then you&#x27;d want to get historical data of other lenders to build your model on.
It sounds a little surprising that you can do this but that&#x27;s basically how the bureaus make their money.</p>
<p>An important thing to keep in mind is that you need to make sure you pull the data at 2 different time periods: (1) when the original application was made so you can use data that is relevant for underwriting (and so you don&#x27;t have forward-looking data resulting in <a href="https://www.kaggle.com/dansbecker/data-leakage">data leakage</a>) and (2) 12 months later (or whatever time period is appropriate for you) to check if the consumer defaulted on their loan.</p>
<p>There&#x27;s a lot more to it and you can expand on things in much more elegant ways to handle different phenomena but for the sake of simplicity, this is essentially how it&#x27;s done.</p>
<p>So, after painfully cleaning up all that data, what do you do with it?</p>
<h2>Building a Probability of Default Model</h2>
<p>Now that you have that glorious dataset you can start to run different <a href="https://en.wikipedia.org/wiki/Logistic_regression">Logistic Regressions</a> or use other classification based <a href="https://www.kdnuggets.com/2016/08/10-algorithms-machine-learning-engineers.html">machine learning</a> algorithms to find hidden patterns and relationships (i.e., <a href="https://blog.minitab.com/blog/adventures-in-statistics-2/what-is-the-difference-between-linear-and-nonlinear-equations-in-regression-analysis#:~:text=If%20the%20equation%20doesn&#x27;t,a%20linear%20equation%2C%20it&#x27;s%20nonlinear.&amp;text=Thetas%20represent%20the%20parameters%20and,one%20parameter%20per%20predictor%20variable.">non-linear functions</a> and <a href="https://en.wikipedia.org/wiki/Interaction_(statistics)">interaction terms</a>).</p>
<p>Personally, this is the most intellectually engaging part of the work. The other work involved in credit risk modeling is usually very stressful and filled with less exciting graphs but here you get to pause, look at data, and, for a moment, try to make a crude approximation of the world. I find this part <em>fascinating</em>.</p>
<p>If we stick with our simple dataset above for our model, we could use our good old friend Python to run that Logistic Regression.</p>
<pre><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="white-space:pre;color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6272a4">1</span><span></span></code></pre></pre>
<p>Wow, look at all of that beautiful, useless statistical output!</p>
<p>It&#x27;s not <em>really</em> useless but 99% of the people involved will not find it useful.
So we probably need an alternative way to show and inform these results to non-technical stakeholders (but you as a data scientist can look at this as much as you&#x27;d like).</p>
<p><img alt="The Glorious Lift Chart!" fetchPriority="high" width="800" height="400" decoding="async" data-nimg="1" class="w-full" style="color:transparent" src="/assets/liftchart.png"/></p>
<!-- -->&lt;p align=&quot;center&quot; style=&quot;padding:0&quot;&gt;&lt;i&gt;The Beloved Lift Chart&lt;/i&gt;&lt;/p&gt;<!-- -->
<p>Cue the <a href="https://www.casact.org/education/rpm/2016/presentations/PM-LM-4.pdf">Lift Chart</a>. This chart may look fancy but it&#x27;s actually pretty simple, it&#x27;s just <a href="https://www.investopedia.com/terms/d/decile.asp">deciling</a> your data (i.e., sorting and bucketing into 10 equal groups) according to the <em>predicted</em> default rate from your model. It&#x27;s worth noting that this is a quantized and reversed version of the <a href="https://en.wikipedia.org/wiki/Receiver_operating_characteristic">ROC chart</a> and they represent the same information.</p>
<p>There are 3 important pieces of information from this graph:</p>
<ol>
<li>The AUC tells you the performance</li>
<li>The closer the two lines are together the more accurate the probability estimate</li>
<li>The steeper the slope at the higher deciles, the better the rank order separation</li>
</ol>
<p>If you had perfect information, you&#x27;d get a graph that looks like this:</p>
<p><img alt="The Perfect Lift Chart!" fetchPriority="high" width="800" height="400" decoding="async" data-nimg="1" class="w-full" style="color:transparent" src="/assets/liftchart_optimal.png"/></p>
<!-- -->&lt;p align=&quot;center&quot; style=&quot;padding:0&quot;&gt;&lt;i&gt;If your model looks like this, you&#x27;ve done something terribly wrong&lt;/i&gt;&lt;/p&gt;<!-- -->
<p>And here&#x27;s the code to generate those graphs.</p>
<pre><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="white-space:pre;color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6272a4">1</span><span></span></code></pre></pre>
<!-- -->&lt;center&gt;&lt;i&gt;Judge me not by the elegance of my code but by the fact that it runs.&lt;/i&gt;&lt;/center&gt;<!-- -->
<h2>Evaluating your Default Model</h2>
<p>So this visualization is helpful, but how do you quantify the performance into a single number? Well, how about <a href="https://en.wikipedia.org/wiki/Accuracy_and_precision">Accuracy</a>?</p>
<p>It turns out that Accuracy isn&#x27;t really a great metric when you have a low default rate (or more generally when you have severe <a href="https://en.wikipedia.org/wiki/Accuracy_paradox">class imbalance</a>). As an example suppose you have a 5% default rate, that means 95% of your data did <em>not default</em>, so if your model predicted that no one defaulted, you&#x27;d have 95% accuracy.</p>
<p>Accurate, obvious, and entirely useless. Without proper adjustment, this behavior is actually very likely to occur in your model, so we tend to ignore the accuracy metric and instead we focus on the rank order seperation/predictive power of the model.</p>
<p>To measure that predictive power, there are 4 metrics industry professionals typically look at to summarize their model: <a href="https://en.wikipedia.org/wiki/Precision_and_recall">Precision, Recall</a>, the <a href="https://en.wikipedia.org/wiki/Kolmogorov%E2%80%93Smirnov_test">Kolomogorov-Smirnov (KS) Test</a>, and <a href="https://en.wikipedia.org/wiki/Receiver_operating_characteristic#Area_under_the_curve">Gini/AUC</a>.</p>
<p>One point of humor that has been a surprisingly common topic of discussion in my career is the equivalence of Gini and AUC. Bankers like Gini, for whatever inertia related reason, but it&#x27;s equivalent to AUC via:</p>
<p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="white-space:pre;color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6272a4">1</span><span></span></code></pre></p>
<p>and obviously</p>
<p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="white-space:pre;color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6272a4">1</span><span></span></code></pre>.</p>
<p>Gini is bound between [-1, 1] and AUC between [0, 1] but technically if your AUC is less than 0.5 (and &lt; 0 for Gini) that means you&#x27;re doing worse than random (<a href="https://stats.stackexchange.com/questions/266387/can-auc-roc-be-between-0-0-5">and you could do better by literally doing the opposite of what your model says</a>) so most people will say AUC is between [0.5, 1] and that Gini is between [0, 1].</p>
<p>A good model is usually around 70% AUC / 40% Gini. The higher the better.</p>
<p>It&#x27;s always useful to look at your lift chart as it can tell you a lot about how predictive the model is at different deciles. In some cases, your model may not have enough variation in the attributes/features/predictors to differentiate your data meaningfully. The metric won&#x27;t show you that, only a glance at the lift chart will, so it&#x27;s always a good to review it.</p>
<p>One important point here is that any single metric is very crude and a data set can be pathologically constructed to break it, so while these metrics and charts are very helpful, there are cases where things can still misbehave even though they seem normal.</p>
<p>Now that you have your exciting new default model, you can use it in your underwriting strategy to differentiate amongst your competitors on pricing, approve/decline, and targeting customers, right?</p>
<p>Not quite.</p>
<h2>Common Mistakes and Pitfalls</h2>
<p>Before you get too excited about your model, you want to verify that it&#x27;s behaving logically, so I thought I&#x27;d list some items that you will want to check against to make sure nothing disastrous will happen.</p>
<ul>
<li>Double check for <a href="https://www.kaggle.com/dansbecker/data-leakage">Data Leakage</a></li>
<li>Verify that you don&#x27;t have any <a href="https://www.datasciencecentral.com/profiles/blogs/common-errors-in-machine-learning-due-to-poor-statistics-knowledg">data errors</a></li>
<li>Make sure you&#x27;ve done your best not to fall for <a href="https://en.wikipedia.org/wiki/Simpson%27s_paradox">Simpson&#x27;s Paradox</a></li>
<li>Validate your model with an <a href="https://statmodeling.stat.columbia.edu/2016/11/22/30560/">Out of Time</a> Hold Out Sample</li>
<li>Confirm your model actually has a <a href="https://www.investopedia.com/terms/r/representative-sample.asp#:~:text=A%20representative%20sample%20is%20a,three%20males%20and%20three%20females.">representative sample</a> of your future portfolio</li>
<li>Make sure you&#x27;re not time traveling<!-- -->
<ul>
<li>This is a form of Data Leakage (Leaky Predictors) and it&#x27;s basically making sure you don&#x27;t use data that&#x27;s in the future of what you&#x27;re representing (except the default flags that you&#x27;re trying to predict/model)</li>
</ul>
</li>
<li>Understand the correlation your <em>predicted default</em> may have to your other products in your portfolio<!-- -->
<ul>
<li>This is not important from a statistical perspective but it is very important for your business</li>
</ul>
</li>
<li>Always be skeptical if your model performs too well<!-- -->
<ul>
<li>This is very likely data leakage and can be very embarrassing if you over-excite management</li>
</ul>
</li>
</ul>
<p>I could have written a book (<a href="https://www.amazon.com/Credit-Risk-Modelling-Theoretical-Foundations-Diagnostic-ebook/dp/B07FZGG63V">recommendation here</a>) with a much longer set of information both from a statistical and business lense but, for the sake of brevity, I wrote the most pressing ones and I invite you to search for more information about other important details.</p>
<h2>Some other Interesting Extensions</h2>
<h3>Model Extensions</h3>
<p>The model I showed above is quite literally the most basic example and the models that most lenders and vendors use are much, much more sophisticated. Many of them have enhanced their models to handle <a href="https://en.wikipedia.org/wiki/Panel_data">panel data</a> (i.e., cohorts of people over time) and can construct models that are extremely robust.</p>
<p>The best class of models in this elite category (in my personal opinion) are <a href="https://bookdown.org/content/4253/fitting-basic-discrete-time-hazard-models.html">Discrete Time Survival Models</a>. Actually, this isn&#x27;t <em>my</em> opinon, this wisdom was shared with me from two of the former heads of statistical modeling at Capital One, so don&#x27;t trust my judgement, trust theirs.</p>
<h3>Quantization and the Weight of Evidence</h3>
<p>Another interesting implementation detail is that statisticians/data scientists in the credit scoring space often transform the inputs/attributes/features of their model via <a href="https://en.wikipedia.org/wiki/Quantization">quantization</a>. More specifically through a transformation called the <a href="https://multithreaded.stitchfix.com/blog/2015/08/13/weight-of-evidence/">Weight of Evidence</a>. It&#x27;s neat, troglodytic, and surprisingly effective.</p>
<h3>Adverse Action Reasons</h3>
<p>Credit risk modeling requires the underwriter to grant adverse action codes in the case of rejecting a customer who applies for a credit product (this is a driven by the FCRA). Doing this algorithmitically is very doable and different organizations do it slightly differently but the short version is you take the absolute largest partial predictions (i.e., <pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="white-space:pre;color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6272a4">1</span><span></span></code></pre>,  <pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="white-space:pre;color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6272a4">1</span><span></span></code></pre>).</p>
<h3>Model Complexity and Usefulness</h3>
<p>Lastly, when building these statistical models the most important thing to think about is the trade-off between complexity and performance on your target population. Typically in the lending space you will not approve all of your customers, so obsessing over model fit on the proportion of your population that won&#x27;t be approved is not always useful. It&#x27;s a small point, but extremely consequential and will hopefully save you some time.</p>
<h2>Conclusion</h2>
<p>This tutorial was not nearly as code heavy as I would have liked (only showing a very silly regression) but I felt like the content was still rather dense (<a href="https://github.com/franciscojavierarceo/Python/blob/master/demos/credit-model-demo.py">the full code is available here</a>).</p>
<p>People spend their careers studying these statistical models and the important consequences of them, so I really want to emphasize how much I have trivialized the work here only for the sake of simplicity. I have not talked about how you can improve the model when it&#x27;s underperforming or how one can try to measure biases that may occur, but these are important pieces for society.</p>
<p>I will conclude by saying that these models are heavily governed by many layers of regulation. As a statistician and a minority, I think this is a good thing.
That&#x27;s not to say that harm isn&#x27;t caused by these models because I think there is but I do think machines are more easily governed, evaluated, and modified...unlike human decision making which can be subjective and prone to unknown biases that are difficult to quantify (<a href="https://faculty.haas.berkeley.edu/morse/research/papers/discrim.pdf">here&#x27;s some additional reading material</a>).</p>
<p>I hope you found this post useful and interesting.</p>
<p><em>Have some feedback? Feel free to <a href="https://twitter.com/franciscojarceo">let me know</a>!</em></p></div></article></main><footer class="text-lg font-light"><div style="padding-top:10px;padding-bottom:10px"><a class="text-lg font-bold" href="/">← Back home</a></div><hr/><div><p>Like this blog? Check out the code on my<!-- --> <a href="https://github.com/franciscojavierarceo/franciscojavierarceo.github.io" class="text-link-blue">GitHub</a>.</p><p>Built with<!-- --> <a href="https://nextjs.org/" class="text-link-blue">Next.js</a> and ☕</p></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json" crossorigin="">{"props":{"pageProps":{"frontmatter":{"title":"How to Build a Credit Risk Model","description":"A Data Scientists Guide to Building a Basic Credit Risk Model","date":"January 31, 2021"},"post":{"content":"\n*TL;DR: A Data Science Tutorial on building a Credit Risk model.*\n\nI previously [wrote](/post/data-science-and-fintech) about some of the work data scientists do in the fintech space, which briefly discussed [credit risk models](https://en.wikipedia.org/wiki/Credit_risk) but I wanted to write a more technical review and talk about what I think are the most important points.\n\nI spent most of my career at banks as a data scientist and built credit risk, fraud, and marketing models in the consumer and commercial space in the US, Australia, and South Africa. I learned a lot from those experiences, so I thought I'd share a simple example of how one of the core pieces of algorithmic/quantitative underwriting is done.\n\nIn this post, I'll try to answer the following questions:\n\n- What is a credit risk model?\n- What data does a credit risk model use?\n- How do you estimate a credit risk model?\n- How do you know if your model is performing well?\n- What are some common mistakes to avoid?\n- What are useful facts to know about credit risk models?\n\nIt's worth caveating up front that this is a very narrow take focused only on the analytical aspect of the work and there is an extraordinary amount of legal, compliance, and business work that I am intentionally omitting.\n\nWith that said, let's dive right in.\n\n## What is a Credit Risk Model?\n\nIn the consumer/retail space, a credit risk model tries to predict the probability that a consumer won't repay money that they've borrowed.\nA simple example of this is an [unsecured personal loan](https://www.investopedia.com/terms/u/unsecuredloan.asp). \n\nLet's suppose you submitted an application to borrow $5,000 from a lender. That lender would want to know the likelihood of [default](https://www.investopedia.com/terms/d/default2.asp) before deciding on (1) whether to give you the loan and (2) the price they want to charge you for borrowing the money. So that probability is probably quite important...but how do they come up with it?\n\n## What Data does a Credit Risk Model Use?\n\nLenders typically use data from the major [Credit Bureaus](https://www.investopedia.com/personal-finance/top-three-credit-bureaus/) that is [FCRA](https://www.ftc.gov/enforcement/statutes/fair-credit-reporting-act) compliant, which basically means that the legal and reputational risk of using this data is very low.\n\nTypically, you'd purchase a dataset from one of the bureaus (or use data inside one of their analytical sandboxes) and clean the dataset into something that looks like the following:\n\n\u003ctable\u003e\n  \u003ctr\u003e\n    \u003cth\u003eDefault\u003c/th\u003e\n    \u003cth\u003eInquiries in Last 6 Months\u003c/th\u003e\n    \u003cth\u003eCredit Utilization\u003c/th\u003e\n    \u003cth\u003eAverage Age of Credit\u003c/th\u003e\n    \u003cth\u003e...\u003c/th\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n    \u003ctd\u003eYes\u003c/td\u003e\n    \u003ctd\u003e2\u003c/td\u003e\n    \u003ctd\u003e0.8\u003c/td\u003e\n    \u003ctd\u003e12\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n    \u003ctd\u003eNo\u003c/td\u003e\n    \u003ctd\u003e8\u003c/td\u003e\n    \u003ctd\u003e0.0\u003c/td\u003e\n    \u003ctd\u003e2\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n  \u003c/tr\u003e\n\u003c/table\u003e\n\nAnd so on.\n\nIn summary, it's just a bunch of data about your borrowing history.\nIt's a little recursive/cyclical because in order to grow your credit you need to have credit but let's ignore that detail.\n\nOne of the most important steps in the model development process is *precisely* defining **default** because this will eventually reflect the performance of your portfolio defining it thoughtfully, accurately, and confidently is extremely consequential.\n\nSo how do you define it?\n\nTime. \n\nIf you're planning to launch a term loan, you usually set boundaries on the duration of the loan. For revolving lines of credit (like a credit card), you simply apply a reasonable boundary on time that makes good business sense.\n\nLet's say you want to launch a 12 month loan to an underserved market, then you'd want to get historical data of other lenders to build your model on.\nIt sounds a little surprising that you can do this but that's basically how the bureaus make their money.\n\nAn important thing to keep in mind is that you need to make sure you pull the data at 2 different time periods: (1) when the original application was made so you can use data that is relevant for underwriting (and so you don't have forward-looking data resulting in [data leakage](https://www.kaggle.com/dansbecker/data-leakage)) and (2) 12 months later (or whatever time period is appropriate for you) to check if the consumer defaulted on their loan.\n\nThere's a lot more to it and you can expand on things in much more elegant ways to handle different phenomena but for the sake of simplicity, this is essentially how it's done.\n\nSo, after painfully cleaning up all that data, what do you do with it?\n\n## Building a Probability of Default Model\n\nNow that you have that glorious dataset you can start to run different [Logistic Regressions](https://en.wikipedia.org/wiki/Logistic_regression) or use other classification based [machine learning](https://www.kdnuggets.com/2016/08/10-algorithms-machine-learning-engineers.html) algorithms to find hidden patterns and relationships (i.e., [non-linear functions](https://blog.minitab.com/blog/adventures-in-statistics-2/what-is-the-difference-between-linear-and-nonlinear-equations-in-regression-analysis#:~:text=If%20the%20equation%20doesn't,a%20linear%20equation%2C%20it's%20nonlinear.\u0026text=Thetas%20represent%20the%20parameters%20and,one%20parameter%20per%20predictor%20variable.) and [interaction terms](https://en.wikipedia.org/wiki/Interaction_(statistics))).\n\nPersonally, this is the most intellectually engaging part of the work. The other work involved in credit risk modeling is usually very stressful and filled with less exciting graphs but here you get to pause, look at data, and, for a moment, try to make a crude approximation of the world. I find this part *fascinating*.\n\nIf we stick with our simple dataset above for our model, we could use our good old friend Python to run that Logistic Regression.\n\n```python\nimport numpy as np\nimport statsmodels.api as sm\n\n# Generating the data \nn = 10000\nnp.random.seed(0)\nx_1 = np.random.poisson(lam=5, size=n)\nx_2 = np.random.poisson(lam=2, size=n)\nx_3 = np.random.poisson(lam=12, size=n)\ne = np.random.normal(size=n, loc=0, scale=1.)\n\n# Setting the coefficient values to give us a ~5% default rate\nb_1, b_2, b_3 = -0.005, -0.03, -0.15\nylogpred =  x_1 * b_1 + x_2 * b_2 + x_3 * b_3 + e\nyprob = 1./ (1.+ np.exp(-ylogpred))\nyclass = np.where(yprob \u003e= 0.5, 1, 0)\nxs = np.hstack([\n    x_1.reshape(n, 1), \n    x_2.reshape(n, 1), \n    x_3.reshape(n, 1)\n])\n# Adding an intercept to the matrix\nxs = sm.add_constant(xs)\nmodel = sm.Logit(yclass, xs)\n# All that work just to run .fit(), how terribly uninteresting\nres = model.fit()\nprint(res.summary())\n\n         Current function value: 0.163863\n         Iterations 8\n                           Logit Regression Results                           \n==============================================================================\nDep. Variable:                      y   No. Observations:                10000\nModel:                          Logit   Df Residuals:                     9996\nMethod:                           MLE   Df Model:                            3\nDate:                Fri, 29 Jan 2021   Pseudo R-squ.:                  0.1056\nTime:                        00:08:17   Log-Likelihood:                -1638.6\nconverged:                       True   LL-Null:                       -1832.2\nCovariance Type:            nonrobust   LLR p-value:                 1.419e-83\n==============================================================================\n                 coef    std err          z      P\u003e|z|      [0.025      0.975]\n------------------------------------------------------------------------------\nconst          0.4535      0.209      2.166      0.030       0.043       0.864\nx1            -0.0439      0.023     -1.949      0.051      -0.088       0.000\nx2            -0.0390      0.035     -1.109      0.267      -0.108       0.030\nx3            -0.3065      0.017    -18.045      0.000      -0.340      -0.273\n==============================================================================\n```\n\nWow, look at all of that beautiful, useless statistical output! \n\nIt's not *really* useless but 99% of the people involved will not find it useful. \nSo we probably need an alternative way to show and inform these results to non-technical stakeholders (but you as a data scientist can look at this as much as you'd like).\n\n![The Glorious Lift Chart!](liftchart.png)\n\u003cp align=\"center\" style=\"padding:0\"\u003e\u003ci\u003eThe Beloved Lift Chart\u003c/i\u003e\u003c/p\u003e\n\nCue the [Lift Chart](https://www.casact.org/education/rpm/2016/presentations/PM-LM-4.pdf). This chart may look fancy but it's actually pretty simple, it's just [deciling](https://www.investopedia.com/terms/d/decile.asp) your data (i.e., sorting and bucketing into 10 equal groups) according to the *predicted* default rate from your model. It's worth noting that this is a quantized and reversed version of the [ROC chart](https://en.wikipedia.org/wiki/Receiver_operating_characteristic) and they represent the same information.\n\nThere are 3 important pieces of information from this graph: \n\n1. The AUC tells you the performance\n2. The closer the two lines are together the more accurate the probability estimate\n3. The steeper the slope at the higher deciles, the better the rank order separation\n\nIf you had perfect information, you'd get a graph that looks like this:\n\n![The Perfect Lift Chart!](liftchart_optimal.png)\n\u003cp align=\"center\" style=\"padding:0\"\u003e\u003ci\u003eIf your model looks like this, you've done something terribly wrong\u003c/i\u003e\u003c/p\u003e\n\nAnd here's the code to generate those graphs.\n\n```python\nimport numpy as np\nimport pandas as pd\nfrom matplotlib import pyplot as plt\nfrom sklearn.metrics import roc_auc_score\n\ndef liftchart(df: pd.DataFrame, actual: str, predicted: str, buckets: int=10) -\u003e None:\n    # Bucketing the predictions (Deciling is the default)\n    df['predbucket'] = pd.qcut(x=df[predicted], q=buckets)\n    sdf = df[[actual, predicted, 'predbucket']].groupby(\n        by=['predbucket']).agg({\n        actual: [np.mean, sum, len], \n        predicted: np.mean\n        }\n    )\n    aucperf = roc_auc_score(df[actual], df[predicted])\n    sdf.columns = sdf.columns.map(''.join) # I hate pandas multi-indexing\n    sdf = sdf.rename({\n        actual + 'mean': 'Actual Default Rate', \n        predicted + 'mean': 'Predicted Default Rate'\n    }, axis=1)\n    sdf[['Actual Default Rate', 'Predicted Default Rate']].plot(\n        kind='line', style='.-', grid=True, figsize=(12, 8), \n        color=['red', 'blue']\n    )\n    plt.ylabel('Default Rate')\n    plt.xlabel('Decile Value of Predicted Default')\n    plt.title('Actual vs Predicted Default Rate sorted by Predicted Decile \\nAUC = %.3f' % aucperf)\n    plt.xticks(\n        np.arange(sdf.shape[0]), \n        sdf['Predicted Default Rate'].round(3)\n    )\n    plt.show()\n\n# Using the data and model from before!\npdf = pd.DataFrame(xs, columns=['intercept', 'x1', 'x2', 'x3'])\npdf['preds'] = res.predict(xs)\npdf['actual'] = yclass\n\n# Finally, what we all came here to see\nliftchart(pdf, 'actual', 'preds')\n\n# This is what it looks like when we have perfect information\npdf['truth'] = pdf['actual'] + np.random.uniform(low=0, high=0.001, size=pdf.shape[0])\nliftchart(pdf, 'actual', 'truth', 10)\n```\n\u003ccenter\u003e\u003ci\u003eJudge me not by the elegance of my code but by the fact that it runs.\u003c/i\u003e\u003c/center\u003e\n\n## Evaluating your Default Model\n\nSo this visualization is helpful, but how do you quantify the performance into a single number? Well, how about [Accuracy](https://en.wikipedia.org/wiki/Accuracy_and_precision)?\n\nIt turns out that Accuracy isn't really a great metric when you have a low default rate (or more generally when you have severe [class imbalance](https://en.wikipedia.org/wiki/Accuracy_paradox)). As an example suppose you have a 5% default rate, that means 95% of your data did *not default*, so if your model predicted that no one defaulted, you'd have 95% accuracy.\n\nAccurate, obvious, and entirely useless. Without proper adjustment, this behavior is actually very likely to occur in your model, so we tend to ignore the accuracy metric and instead we focus on the rank order seperation/predictive power of the model.\n\nTo measure that predictive power, there are 4 metrics industry professionals typically look at to summarize their model: [Precision, Recall](https://en.wikipedia.org/wiki/Precision_and_recall), the [Kolomogorov-Smirnov (KS) Test](https://en.wikipedia.org/wiki/Kolmogorov–Smirnov_test), and [Gini/AUC](https://en.wikipedia.org/wiki/Receiver_operating_characteristic#Area_under_the_curve).\n\nOne point of humor that has been a surprisingly common topic of discussion in my career is the equivalence of Gini and AUC. Bankers like Gini, for whatever inertia related reason, but it's equivalent to AUC via:\n\n$$Gini = 2 * AUC - 1$$ \n\nand obviously\n\n$$AUC = \\frac{Gini+1}{2}$$.\n\nGini is bound between [-1, 1] and AUC between [0, 1] but technically if your AUC is less than 0.5 (and \u003c 0 for Gini) that means you're doing worse than random ([and you could do better by literally doing the opposite of what your model says](https://stats.stackexchange.com/questions/266387/can-auc-roc-be-between-0-0-5)) so most people will say AUC is between [0.5, 1] and that Gini is between [0, 1].\n\nA good model is usually around 70% AUC / 40% Gini. The higher the better.\n\nIt's always useful to look at your lift chart as it can tell you a lot about how predictive the model is at different deciles. In some cases, your model may not have enough variation in the attributes/features/predictors to differentiate your data meaningfully. The metric won't show you that, only a glance at the lift chart will, so it's always a good to review it.\n\nOne important point here is that any single metric is very crude and a data set can be pathologically constructed to break it, so while these metrics and charts are very helpful, there are cases where things can still misbehave even though they seem normal.\n\nNow that you have your exciting new default model, you can use it in your underwriting strategy to differentiate amongst your competitors on pricing, approve/decline, and targeting customers, right?\n\nNot quite.\n\n## Common Mistakes and Pitfalls\n\nBefore you get too excited about your model, you want to verify that it's behaving logically, so I thought I'd list some items that you will want to check against to make sure nothing disastrous will happen. \n\n- Double check for [Data Leakage](https://www.kaggle.com/dansbecker/data-leakage)\n- Verify that you don't have any [data errors](https://www.datasciencecentral.com/profiles/blogs/common-errors-in-machine-learning-due-to-poor-statistics-knowledg)\n- Make sure you've done your best not to fall for [Simpson's Paradox](https://en.wikipedia.org/wiki/Simpson%27s_paradox)\n- Validate your model with an [Out of Time](https://statmodeling.stat.columbia.edu/2016/11/22/30560/) Hold Out Sample\n- Confirm your model actually has a [representative sample](https://www.investopedia.com/terms/r/representative-sample.asp#:~:text=A%20representative%20sample%20is%20a,three%20males%20and%20three%20females.) of your future portfolio\n- Make sure you're not time traveling \n    - This is a form of Data Leakage (Leaky Predictors) and it's basically making sure you don't use data that's in the future of what you're representing (except the default flags that you're trying to predict/model)\n- Understand the correlation your *predicted default* may have to your other products in your portfolio\n    - This is not important from a statistical perspective but it is very important for your business\n- Always be skeptical if your model performs too well\n    - This is very likely data leakage and can be very embarrassing if you over-excite management\n\nI could have written a book ([recommendation here](https://www.amazon.com/Credit-Risk-Modelling-Theoretical-Foundations-Diagnostic-ebook/dp/B07FZGG63V)) with a much longer set of information both from a statistical and business lense but, for the sake of brevity, I wrote the most pressing ones and I invite you to search for more information about other important details.\n\n## Some other Interesting Extensions\n\n\n### Model Extensions\nThe model I showed above is quite literally the most basic example and the models that most lenders and vendors use are much, much more sophisticated. Many of them have enhanced their models to handle [panel data](https://en.wikipedia.org/wiki/Panel_data) (i.e., cohorts of people over time) and can construct models that are extremely robust.\n\nThe best class of models in this elite category (in my personal opinion) are [Discrete Time Survival Models](https://bookdown.org/content/4253/fitting-basic-discrete-time-hazard-models.html). Actually, this isn't *my* opinon, this wisdom was shared with me from two of the former heads of statistical modeling at Capital One, so don't trust my judgement, trust theirs.\n\n### Quantization and the Weight of Evidence\nAnother interesting implementation detail is that statisticians/data scientists in the credit scoring space often transform the inputs/attributes/features of their model via [quantization](https://en.wikipedia.org/wiki/Quantization). More specifically through a transformation called the [Weight of Evidence](https://multithreaded.stitchfix.com/blog/2015/08/13/weight-of-evidence/). It's neat, troglodytic, and surprisingly effective.\n\n\n### Adverse Action Reasons\nCredit risk modeling requires the underwriter to grant adverse action codes in the case of rejecting a customer who applies for a credit product (this is a driven by the FCRA). Doing this algorithmitically is very doable and different organizations do it slightly differently but the short version is you take the absolute largest partial predictions (i.e., $argmax_{x}f(x_j) = |x_j * \\beta_j|$,  $\\forall j=1,..., k$).\n\n### Model Complexity and Usefulness\nLastly, when building these statistical models the most important thing to think about is the trade-off between complexity and performance on your target population. Typically in the lending space you will not approve all of your customers, so obsessing over model fit on the proportion of your population that won't be approved is not always useful. It's a small point, but extremely consequential and will hopefully save you some time.\n\n## Conclusion\n\nThis tutorial was not nearly as code heavy as I would have liked (only showing a very silly regression) but I felt like the content was still rather dense ([the full code is available here](https://github.com/franciscojavierarceo/Python/blob/master/demos/credit-model-demo.py)).\n\nPeople spend their careers studying these statistical models and the important consequences of them, so I really want to emphasize how much I have trivialized the work here only for the sake of simplicity. I have not talked about how you can improve the model when it's underperforming or how one can try to measure biases that may occur, but these are important pieces for society.\n\nI will conclude by saying that these models are heavily governed by many layers of regulation. As a statistician and a minority, I think this is a good thing.\nThat's not to say that harm isn't caused by these models because I think there is but I do think machines are more easily governed, evaluated, and modified...unlike human decision making which can be subjective and prone to unknown biases that are difficult to quantify ([here's some additional reading material](https://faculty.haas.berkeley.edu/morse/research/papers/discrim.pdf)).\n\nI hope you found this post useful and interesting.\n\n*Have some feedback? Feel free to [let me know](https://twitter.com/franciscojarceo)!*","excerpt":""},"previousPost":{"slug":"data-science-and-fintech","frontmatter":{"title":"Data Science and Fintech","description":"How Data Science Scaled the Fintech Revolution","date":"January 22, 2021"},"excerpt":"","content":"\nI've spent the last 10 years working in data science, mostly in finance and technology (fintech) and it's been really exciting to see how data science, engineering, and the internet has reshaped all aspects of finance.\n\n[Others have written before](https://fintechtoday.substack.com/p/part-1-what-is-fintech-30-anyway) about how fintech has evolved over the last decade and one area that I think is interesting is how data science and analytics has helped fuel that growth.\n\n\u003eSo, how ***exactly*** has data science helped scale fintech?\n\nI think data science has scaled fintech in five key areas.\n\n## 1. Operations\u003ca name=\"Operations\"\u003e\u003c/a\u003e\n\nThe market tends to have a preference for technology companies because of the operational efficiencies that come from technology's scale. Simply put, data scientists help identify data and processes that can be automated to help achieve better operational efficiency.\n\nA concrete fintech example of this is fraud operations. If you're a bank with a credit card product, manually reviewing even 10% of your credit card transactions would be an impossible, and costly, task (it's been [cited](https://www.marketwatch.com/story/why-bitcoin-wont-displace-visa-or-mastercard-soon-2017-12-15) that Visa and Mastercard process 5,000 transactions per second, which would mean that there are 5000 * 60 * 60 * 24=432,000,000 transactions per day to go through).\n\nSo, in this circumstance data scientists build technology and predictive models to reduce the amount of manual review.\n\n## 2. Marketing\u003ca name=\"Marketing\"\u003e\u003c/a\u003e\n\nIn fintech, Customer Acquisition Cost (CAC) is everything. Others have written about [CAC and fintech](https://medium.com/unifimoney/the-no-cac-bank-5e0e577d5473) in greater depth, but suffice it to say it is a challenging and competitive problem.\n\nData scientists focused on marketing try to reduce CAC through a wide variety of strategies.\nSome of them are by tightly monitoring product metrics to see which features yield the best ROI for growth, while other approaches take a broader lense by taking a comprehensive view of your marketing investments and, again, optimize the expected return (e.g., through [Marketing Mix Models](https://blog.hurree.co/blog/marketing-mix-modeling)).\n\nOther marketing focused approaches use [propensity models](https://medium.com/the-official-integrate-ai-blog/heres-what-you-need-to-know-about-propensity-modeling-521ab660cb43) to try to maximize customer engagement or acquisition. More concretely, this can involve building a propensity model to convert a customer from an email subscriber to a fully-converted user (e.g., for a lending product or a mobile application), while other propensities may focus on simply getting a customer to re-engage with your product.\n\n## 3. Risk Management\u003ca name=\"Risk-Management\"\u003e\u003c/a\u003e\n\nThis is where I've spent most of my career and I think it's a really hard problem that most fintechs struggle with in the lending space.\nGenerally speaking, data scientists will build risk models (e.g., for credit risk or fraud risk) to predict the probability of default or some likelihood of delinquency ([more on the difference between them](https://www.investopedia.com/ask/answers/062315/what-are-differences-between-delinquency-and-default.asp)).\n\nBuilding good predictive models is hard. Building good *risk* models is **extremely** hard.\n\nThis is less because of a technology or data problem and more because of regulatory checks and balances in place. Making sure that you adhere to [FCRA](https://www.ftc.gov/enforcement/statutes/fair-credit-reporting-act), [ECOA](https://uscode.house.gov/view.xhtml?req=granuleid%3AUSC-prelim-title15-chapter41-subchapter4\u0026edition=prelim), and other regulatory oversight is hard on its own, adding statistical analysis into the mix makes it more challenging.\n\nImplementation (i.e., getting an algorithm into production that impacts your customers) of these models is a whole other area of data science and one of the areas I personally find quite fun (maybe I'll write more about this topic later).\n\n## 4. Technology\u003ca name=\"Technology\"\u003e\u003c/a\u003e\n\nData scientists often work with engineering/technology teams in order to improve the technology stack. This may involve changing an architecture to reduce the latency of certain [microservices](https://microservices.io/) or enhancing the curent stack for a unique problem (cue machine learning and [Airflow DAGs](https://airflow.apache.org)).\nWhile some of this is behind the scenes, it can be some of the most impactful work done by a data scientist in the fintech space because of the broader impact to the core business.\n\n## 5. Product\u003ca name=\"Product\"\u003e\u003c/a\u003e\n\nData scientists working with product teams are often tasked with the measurement of different experiences within the product and finding out ways to enhance it. That can vary from creating dashboards to monitor the right metrics, to building a recommendation system to curate something specific for a user. \n\nData scientists can fuel product growth, which is why [Facebook, Google, Amazon, Microsoft](https://www.datasciencedegreeprograms.net/lists/five-of-the-largest-companies-that-employ-data-scientists/) and other tech companies hire so many data scientists.\n\nIt's worth noting that I've ignored many of the technology and organizational complexities involved when hiring or building data science teams but only because I wanted to keep this post high-level to introduce some of the applications of data science to fintech. In the future, I'll probably write more technical posts of each one of these to give more concrete examples with code and diagrams (which is what I find fun 😊). \n\nTo summarize, data scientists are useful (particularly in fintech) when there are hard problems and data available to solve them.\n\n*Have some feedback? Feel free to [let me know](https://twitter.com/franciscojarceo)!*"},"nextPost":{"slug":"customer-segmentation-data-science","frontmatter":{"title":"Customer Segmentation using Data Science","description":"A Data Scientists Guide to Segmenting your Customers using clustering algorithms and decision trees.","date":"February 6, 2021"},"excerpt":"","content":"\n*TL;DR: A Data Science Tutorial on using K-Means and Decision Trees together.*\n\nCustomer segmentation (sometimes called [Market Segmentation](https://en.wikipedia.org/wiki/Market_segmentation)) is ubiqutous in the private sector. We think about bucketing people into $k$ mutually exclusive and collectively exhausting (MECE) groups. The premise being that instead of having 1 strategy for delivering a product or experience, providing $k$ experiences or strategies will yield much better engagement or acquisition from our customers.\n\nGenerally speaking, this makes sense; it's intuitive. Provide people a more curated experience and they will enjoy it more...and the more personalized the better. \n\nNetflix, Spotify, YouTube, Twiter, Instagram, and all of the big tech companies have mastered personalization by using robust, computationally expensive, and sophisticated machine learning pipelines. But the world has been doing this for a long time, just a much less sophisticated version.\n\nSo I thought I'd give a technical demo of what customer segmentation looks like in a basic way using a trick I've used for years.\n\nHere are the things I'd like to cover during this demo:\n\n1. What options do I have to segment my customers?\n2. How do I actually do the segmentation?\n3. What can I do with my new customer segments?\n4. How do I know that my segments are effective?\n5. How do I know when my segments have changed?\n\n## Approaches to Customer Segmentation\n\nThe phrase \"Customer Segments\" tends to mean different things across different industries, organizations, and even across business functions (e.g., marketing, risk, product, etc.). \n\nAs an example, for a consumer products retailer, they may refer to customer segments using both demographic information or their purchase behavior, where a lender may refer to their segments based on credit score bands. While very meaningfully different from a business perspective, the same algorithms can be used for both problems.\n\nAnalytically speaking, I've seen Customer Segments defined really in two main ways: (1) Business Segments and (2) Algorithmic Segments. Usually executives refer to their segments in the first category and data scientists focus on the second. The first is really important organizationally because 99% of the people working with your customers don't care about how you bucketed them and customers are the most important thing. Always.\n\n...but how do you *actually* (i.e., in code and data) get to those segments?\n\n### 1. Logical Business Segments\nThese segments tend to be defined by heuristics and things that make common sense. They are often built on things that are aligned with the goal of the business.\n\nHere are some examples:\n\n- The age of the customer (in years)\n- The income of the customer (in dollars or thousands of dollars)\n- The amount of money a customer spent in the last year\n- The likelihood a customer will spend money at a given store (purchase propensity / propensity to buy)\n- The customer's geographic region (e.g., zipcode, state)\n\nIn data, some of that customer information would look something like this:\n\n\u003ctable\u003e\n  \u003ctr\u003e\n    \u003cth\u003eUser ID\u003c/th\u003e\n    \u003cth\u003eAge\u003c/th\u003e\n    \u003cth\u003eCustomer Income\u003c/th\u003e\n    \u003cth\u003ePurchase Propensity\u003c/th\u003e\n    \u003cth\u003e...\u003c/th\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n    \u003ctd\u003e1\u003c/td\u003e\n    \u003ctd\u003e25\u003c/td\u003e\n    \u003ctd\u003e$45,000\u003c/td\u003e\n    \u003ctd\u003e0.9\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n    \u003ctd\u003e2\u003c/td\u003e\n    \u003ctd\u003e30\u003c/td\u003e\n    \u003ctd\u003e$80,000\u003c/td\u003e\n    \u003ctd\u003e0.4\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n    \u003ctd\u003en\u003c/td\u003e\n    \u003ctd\u003e56\u003c/td\u003e\n    \u003ctd\u003e$57,000\u003c/td\u003e\n    \u003ctd\u003e0.1\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n  \u003c/tr\u003e\n\u003c/table\u003e\nAnd so on.\n\nWe could apply some logic/rules/code to create segment like:\n\n- Age Buckets\n    1. \u003c 25\n    2. 25-35\n    3. 35-55\n    4. 55+\n- Income Buckets\n    1. \u003c $25K\n    2. $25K-50K\n    3. $50K-100K\n    4. $100-150K\n    5. $150K+\n- Propensity Buckets\n    1. Low: [0, 0.25]\n    2. Medium: [0.25, 0.75]\n    3. High: [0.75, 1.0]\n\nAnd map that logic into our data, which would yield\n\u003ctable\u003e\n  \u003ctr\u003e\n    \u003cth\u003eUser ID\u003c/th\u003e\n    \u003cth\u003eAge Bucket\u003c/th\u003e\n    \u003cth\u003eIncome Bucket\u003c/th\u003e\n    \u003cth\u003ePropensity Bucket\u003c/th\u003e\n    \u003cth\u003e...\u003c/th\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n    \u003ctd\u003e1\u003c/td\u003e\n    \u003ctd\u003e25-35\u003c/td\u003e\n    \u003ctd\u003e$25K-50K\u003c/td\u003e\n    \u003ctd\u003eHigh\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n    \u003ctd\u003e2\u003c/td\u003e\n    \u003ctd\u003e25-35\u003c/td\u003e\n    \u003ctd\u003e$50K-100K\u003c/td\u003e\n    \u003ctd\u003eMedium\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n    \u003ctd\u003en\u003c/td\u003e\n    \u003ctd\u003e56\u003c/td\u003e\n    \u003ctd\u003e$50K-100K\u003c/td\u003e\n    \u003ctd\u003eLow\u003c/td\u003e\n    \u003ctd\u003e...\u003c/td\u003e\n  \u003c/tr\u003e\n\u003c/table\u003e\nAnd so on.\n\nPretty simple, right? The code for this categorization is simple too (assuming you're using Pandas and Python; though it's also simple in SQL).\n\n```python\n# Here's one example\nimport numpy as np\nimport pandas as pd\n\ncdf['Income Bucket'] = pd.cut(cdf['Annual Income ($K)'], \n    bins=[0, 25, 35, 55, np.inf], \n    labels=['\u003c25', '25-35', '35-55', '55+']\n)\n```\nThis is a really helpful and simple way to understand our customers and it's the way that most businesses do analytics, but we can do more. 😊\n\n### 2. Algorithmic Segments\n\nSegments defined using simple business logic are great because they are so easy to interpret, but that's not free.\nBy favoring simplicity we have to limit ourselves to (potentially) suboptimal segments. \nThis is typically on purpose and entirely fine but, again, we can do better.\n\nSo how do we do better?\n\nCue statistics, data mining, analytics, machine learning, or whatever it's called this week. More specifically, we can use the classic [K-Means Clustering](https://en.wikipedia.org/wiki/K-means_clustering) algorithm to *learn* an optimal set of segments given some set of data.\n\nTo skip over many important details ([more here](https://towardsdatascience.com/customer-segmentation-using-k-means-clustering-d33964f238c3)), K-Means is an algorithm that optimally buckets your data into $K$ groups (according to a specific mathematical function called the [euclidean distance](https://en.wikipedia.org/wiki/Euclidean_distance)). It's a classic approach and tends to work quiet well in practice (there are a ton of other neat [clustering algorithms](https://en.wikipedia.org/wiki/Cluster_analysis#Algorithms)) but one non-technical challenge is (1) choosing $K$ and (2) explaining what a single cluster actually means to literally anyone else.\n\nSolving (1) is relatively straight-forward. You can run K-means for some number of $K$ from [0, $m$] ($m \u003e 0$ and choose what appears to be a $k$ that sufficiently minimizes the within-cluster sum-of-squares (i.e., $\\sum_{i=0}^{n} min_{\\mu_j \\in C}||x_i - \\mu_j||^2$). Here notice that the the majority of the variation of the clusters can be capture by $k=6$.\n\n![The Inertia Function!](inertia.png)\n\u003cp align=\"center\" style=\"padding:0\"\u003e\u003ci\u003eInertia as a function of k\u003c/i\u003e\u003c/p\u003e\n\nNow to (2), which is the harder challenge. If I were to plot my data and look at the clusters, I'd have something that looks like:\n\n![K-Means!](kmeans.png)\n\u003cp align=\"center\" style=\"padding:0\"\u003e\u003ci\u003eLook at all 3 of those beautiful dimensions!\u003c/i\u003e\u003c/p\u003e\n\nHow cool, right? This little algorithm learned pretty clear groups that you can see rather obviously in the data. Impressive! And also useless to your boss and colleagues.\n\nMore seriously, while you can see these clusters, you can't actually extract a clear description from it, which makes interpreting it really, really hard when you go past 3 dimensions.\n\nSo what can you do to make this slightly more meaningful?\n\nEnter [decision trees](https://en.wikipedia.org/wiki/Decision_tree). Another elegant, classic, and amazing algorithm. Decision Trees basically split up your data using simple `if-else` statements. So, a trick that you can use is to take the predicted clusters and run a Decision Tree (Classification) to predict the segment and use the learneed Tree's logic as your new business logic.\n\nI find this little trick pretty fun and effective since I can more easily describe how a machine learned a segment and I can also inspect it. Let's suppose I ran my tree on this learned K-means, what would the output look like?\n\n![Decision Tree Ouput!](decisiontree.png)\n\u003cp align=\"center\" style=\"padding:0\"\u003e\u003ci\u003eIs this really more interpretable?\u003c/i\u003e\u003c/p\u003e\n\nThere you have it, now you have a segmentation that is closer to optimal and somewhat easier to interpret. It's still not as good as the business definition but you could actually read through this and eventually come up with a heuristic driven approach as well, which is why I like it and why I've used it in the past.\n\nAnd here's the code to run the K-means and the Decision tree.\n\n```python\nimport pydotplus\nimport pandas as pd\nfrom sklearn.tree import DecisionTreeClassifier\nfrom sklearn.tree import export_graphviz\nfrom sklearn.externals.six import StringIO  \n\noptimal_clusters = 6\n# 6 clusters 6 colors\nxcolors = ['red', 'green', 'blue', 'orange', 'purple', 'gray']\n# Chose 6 as the best number of clusters\nkmeans_model = (KMeans(n_clusters = optimal_clusters,init='k-means++', n_init = 10 ,max_iter=300, \n                        tol=0.0001,  random_state= 111  , algorithm='elkan') )\nkmeans_model.fit(X1)\ncdf['pred_cluster_kmeans'] = kmeans_model.labels_\ncentroids = kmeans_model.cluster_centers_\n\ndisplay(pd.DataFrame(cdf['pred_cluster_kmeans'].value_counts(normalize=True)))\n\nclf = DecisionTreeClassifier()\n# Train Decision Tree Classifer\nclf = clf.fit(X1, cdf['pred_cluster_kmeans'])\n\n# Predict the response for test dataset\ncdf['pred_class_dtree'] = clf.predict(X1)\n\ndisplay(pd.crosstab(cdf['pred_cluster_kmeans'], cdf['pred_class_dtree']))\ndot_data = StringIO()\nexport_graphviz(\n    decision_tree=clf, \n    out_file=dot_data,  \n    filled=True, \n    rounded=False,\n    impurity=False,\n    special_characters=True, \n    feature_names=xcol_labels, \n    class_names=cdf['pred_cluster_kmeans'].unique().astype(str).tolist(),\n\n)\ngraph = pydotplus.graph_from_dot_data(dot_data.getvalue())  \ngraph.write_png(\"./decisiontree.png\")\n```\n## What can you do with your new segments?\n\nNow that we have our customer segments we can do all sorts of different things.\nWe can create [A/B tests](https://www.optimizely.com/optimization-glossary/ab-testing/) for website experiences or we can test the impact of [changing our prices](https://medium.com/@judaikawa/price-elasticity-statistical-modeling-in-the-retail-industry-a-quick-overview-fdab5350222) to certain customers.\nIn general, we can just try a bunch of new stuff.\n\n## How do I know if my segments are accurate?\n\nThe metric we used in the example above (i.e., within cluster sum-of-squares / inertia) was a reasonably straightforward way to measure the accuracy of your segments from an analytical perspective, but if you wanted to take a closer look, I'd recommend reviewing individual users in each segment. It sounds a little silly and can, in some cases, lead to the wrong conclusions but I firmly believe that in data science, you just have to really **look** at your data. You learn a lot from it.\n\n## How do I know when my segments need to change?\n\nLastly, segments can change; your customers are always evolving so it's good to re-evaluate your clusters time and again. The emergence of new segments should feel very obvious, since it may be driven by product or acquisition changes. As a concrete example, if you noticed that important businesss metrics split by your segments are starting to behave a little differently, then you can investigate whether it's driven by a change in the segments; sometimes it is, sometimes it's not.\n\n\n## Conclusion\nThis tutorial ended up being a little longer than I anticipated but oh well, I hope you enjoyed it.\n\nI've stored the code to reproduce this example in a [Jupyter Notebook](https://github.com/franciscojavierarceo/Python/blob/master/demos/Customer%20Segmentation%20Example.ipynb) available on my GitHub (note to render the interactive 3D visualization you have to run the notebook). To get it up and running you only need to download the notebook, [download the data](https://www.kaggle.com/vjchoudhary7/customer-segmentation-tutorial-in-python), install [Docker](https://www.docker.com/get-started), and simply run:\n\n```bash\ndocker run -it -p 8888:8888 -v ~/path/to/your/folder/:/home/jovyan/work --rm --name jupyter jupyter/scipy-notebook:17aba6048f44\n```\n\nAnd you should be good to go. Happy segmenting!\n\n*Have some feedback? Feel free to [let me know](https://twitter.com/franciscojarceo)!*"}},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"how-to-build-a-credit-risk-model"},"buildId":"kJxfpRQQyGIN4m6m9HTPj","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>